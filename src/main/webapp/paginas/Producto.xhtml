<ui:composition
        xmlns:ui="jakarta.faces.facelets"
        xmlns:f="jakarta.faces.core"
        xmlns:h="jakarta.faces.html"
        xmlns:p="http://primefaces.org/ui"
        xmlns:ues="jakarta.faces.composite/ues"
        xmlns="http://www.w3.org/1999/xhtml"
        template="../WEB-INF/plantilla/default.xhtml"
>
    <ui:define name="header">
        <h1>#{defaultfrm['page.producto']}</h1>
    </ui:define>
    <ui:define name="contenido-tabla">
        <h:panelGrid>
            <h:form id="frmTop">
                <p:dataTable value="#{productoFrm.modelo}" var="r"
                             paginator="true"
                             paginatorPosition="bottom"
                             lazy="true"
                             selectionMode="single"
                             selection="#{productoFrm.registro}"
                             rows="#{productoFrm.pageSize}"
                             rendered="#{productoFrm.estado == 'NADA'}"
                             styleClass="tabla-crud">
                    <p:column headerText="ID">
                        <h:outputText value="#{r.id}"/>
                    </p:column>
                    <p:column headerText="Nombre">
                        <h:outputText value="#{r.nombreProducto}"/>
                    </p:column>
                    <p:column headerText="Referencia externa">
                        <h:outputText value="#{r.referenciaExterna}"/>
                    </p:column>
                    <p:column headerText="Estado">
                        <h:outputText value="#{r.activo ? 'Activo' : 'Inactivo'}"/>
                    </p:column>
                    <p:column headerText="Observacion">
                        <h:outputText value="#{r.comentarios}"/>
                    </p:column>
                    <p:ajax event="rowSelect" listener="#{productoFrm.seleccionarRegistro}"
                            update=":pnlDetalle :pnlTabla"/>
                </p:dataTable>
                <ues:botones-top formulario="#{productoFrm}" actualizar=":pnlDetalle :pnlTabla"/>
            </h:form>
        </h:panelGrid>
    </ui:define>

    <ui:define name="contenido-detalle">

        <p:tabView id="tabProducto" cache="false" dynamic="true" rendered="#{productoFrm.estado != 'NADA'}">
            <p:tab closable="false" title="Generalidades">
                <h:form id="frmCrear">
                    <h:panelGrid columns="2">
                        <p:outputLabel for="txtId" value="ID:"/>
                        <p:inputText id="txtId" value="#{productoFrm.registro.id}" readonly="true"
                                     disabled="true"/>
                        <p:outputLabel for="txtNombre" value="Nombre:"/>
                        <p:inputText id="txtNombre" value="#{productoFrm.registro.nombreProducto}" size="75"
                                     required="true"/>
                        <p:outputLabel for="chkActivo" value="Activo:"/>
                        <p:selectBooleanCheckbox id="chkActivo" value="#{productoFrm.registro.activo}"/>
                        <p:outputLabel for="txtObservacion" value="Comentarios:"/>
                        <p:inputTextarea id="txtObservacion" value="#{productoFrm.registro.comentarios}" cols="75"
                                         rows="4"/>
                        <p:outputLabel for="txtReferenciaExterna" value="Referencia Externa:"/>
                        <p:inputTextarea id="txtReferenciaExterna" value="#{productoFrm.registro.referenciaExterna}"
                                         cols="75"
                                         rows="4"/>
                    </h:panelGrid>
                    <ues:botones-crud formulario="#{productoFrm}" actualizar=":pnlDetalle :pnlTabla :tabProducto"/>
                </h:form>
            </p:tab>

            <p:tab closable="false" title="Tipos de producto" disabled="#{productoFrm.estado != 'MODIFICAR'}">
                <h:panelGrid>
                    <h:panelGroup id="pnlTipoProducto">
                        <h2>#{productoFrm.registro.nombreProducto}</h2>
                        <h:form id="frmTablaProducto">
                            <p:dataTable value="#{productoFrm.productoTipoProductoFrm.modelo}" var="tp"
                                         paginator="true"
                                         paginatorPosition="bottom"
                                         lazy="true"
                                         selection="#{productoFrm.productoTipoProductoFrm.registro}"
                                         selectionMode="single"
                                         rows="#{productoFrm.productoTipoProductoFrm.pageSize}"
                                         rendered="#{productoFrm.productoTipoProductoFrm.estado == 'NADA'}">
                                <p:ajax event="rowSelect"
                                        process="@this"
                                        listener="#{productoFrm.productoTipoProductoFrm.seleccionarRegistro}"
                                        update=":tabProducto:pnlTipoProducto :tabProducto:pnlDetalleProducto"/>
                                <p:column headerText="ID">
                                    <h:outputText value="#{tp.id}"/>
                                </p:column>
                                <p:column headerText="Tipo">
                                    <h:outputText value="#{tp.idTipoProducto.nombre}"/>
                                </p:column>

                                <p:column headerText="Fecha de creación">
                                    <h:outputText value="#{tp.fechaCreacion}">
                                        <f:convertDateTime pattern="dd/MM/yyyy HH:mm:ss" timeZone="America/El_Salvador"/>
                                    </h:outputText>
                                </p:column>

                                <p:column headerText="Activo">
                                    <h:outputText value="#{tp.activo?'ACTIVO':'INACTIVO'}"/>
                                </p:column>
                                <p:column headerText="Observacion">
                                    <h:outputText value="#{tp.observaciones}"/>
                                </p:column>
                            </p:dataTable>
                            <ues:botones-top formulario="#{productoFrm.productoTipoProductoFrm}"
                                             actualizar=":tabProducto:pnlTipoProducto :tabProducto:pnlDetalleProducto"/>
                        </h:form>
                    </h:panelGroup>

                    <h:panelGroup id="pnlDetalleProducto">
                        <p:growl id="growlDetalleProducto" showDetail="true"/>
                        <p:growl id="growl-stickyDetalleProducto" for="sticky-key" showDetail="true" sticky="true"/>
                        <h:panelGrid columns="2" rendered="#{productoFrm.productoTipoProductoFrm.estado != 'NADA'}">
                            <h:form id="frmDetalleProducto">
                                <h:panelGrid columns="2">
                                    <p:outputLabel for="txtID" value="ID:"/>
                                    <p:inputText id="txtID"
                                                 value="#{productoFrm.productoTipoProductoFrm.registro.id}"
                                                 readonly="true"
                                                 disabled="true"/>

                                    <h:outputLabel for="txtNombreTipo" value="Tipo:"/>
                                    <h:panelGroup id="pnlTipoProducto">
                                        <h:panelGrid columns="2">
                                            <p:inputText id="txtNombreTipo"
                                                         value="#{productoFrm.productoTipoProductoFrm.registro.idTipoProducto.nombre}"
                                                         size="10" readonly="true" disabled="true"/>
                                            <p:commandButton type="button" onclick="PF('dlgTipoProducto').show();"
                                                             value="Seleccionar Tipo" icon="pi pi-external-link"/>
                                        </h:panelGrid>

                                        <h:panelGrid columns="3"
                                                     rendered="#{not empty productoFrm.productoTipoProductoFrm.posibleCaracteristicas or not empty productoFrm.productoTipoProductoFrm.caracteristicasAsignadas}">
                                            <p:outputLabel value="Caracteristica"/>

                                            <h:panelGrid columns="3">
                                                <h:panelGrid>
                                                    <h:outputLabel value="Disponibles"/>
                                                    <h:selectOneListbox id="lstDisponibles"
                                                                        required="false"
                                                                        value="#{productoFrm.productoTipoProductoFrm.seleccionPosibleCaracteristica}"
                                                                        converter="tipoProductoCaracteristicaConverter">
                                                        <f:selectItems
                                                                value="#{productoFrm.productoTipoProductoFrm.posibleCaracteristicas}"
                                                                var="pc"
                                                                itemLabel="#{pc.idCaracteristica.nombre} (#{pc.idCaracteristica.id})"
                                                                itemValue="#{pc}"/>
                                                    </h:selectOneListbox>
                                                </h:panelGrid>
                                                <h:panelGrid>
                                                    <p:commandButton value="Agregar"
                                                                     actionListener="#{productoFrm.productoTipoProductoFrm.btnAgregarPosibleCaracteristicaHandler}"
                                                                     update=":tabProducto:pnlTipoProducto :tabProducto:pnlDetalleProducto"
                                                                     process="lstDisponibles">
                                                        <f:attribute name="selectedCaracteristica"
                                                                     value="#{productoFrm.productoTipoProductoFrm.seleccionPosibleCaracteristica}"/>
                                                    </p:commandButton>

                                                    <p:commandButton value="Eliminar"
                                                                     actionListener="#{productoFrm.productoTipoProductoFrm.btnEliminarCaracteristicaAsignadaHandler}"
                                                                     update=":tabProducto:pnlTipoProducto :tabProducto:pnlDetalleProducto"
                                                                     process="lstAsignadas">
                                                        <f:attribute name="selectedCaracteristica"
                                                                     value="#{productoFrm.productoTipoProductoFrm.seleccionCaracteristicaAsignada}"/>
                                                        <f:attribute name="obligatoria"
                                                                     value="#{productoFrm.productoTipoProductoFrm.seleccionCaracteristicaAsignada != null ?
                                                                     productoFrm.productoTipoProductoFrm.seleccionCaracteristicaAsignada.obligatorio : false}"/>
                                                    </p:commandButton>
                                                </h:panelGrid>


                                                <h:panelGrid>
                                                    <h:outputLabel value="Asignadas"/>

                                                    <h:selectOneListbox id="lstAsignadas"
                                                                        value="#{productoFrm.productoTipoProductoFrm.seleccionCaracteristicaAsignada}"
                                                                        converter="tipoProductoCaracteristicaConverter">
                                                        <f:selectItems
                                                                value="#{productoFrm.productoTipoProductoFrm.caracteristicasAsignadas}"
                                                                var="ca"
                                                                itemLabel="#{ca.idCaracteristica.nombre} #{not empty productoFrm.productoTipoProductoFrm.getEquivalenciaPara(ca) ? ' - ' : ''}#{productoFrm.productoTipoProductoFrm.getEquivalenciaPara(ca)} #{ca.idCaracteristica.idTipoUnidadMedida.unidadBase}"
                                                                itemValue="#{ca}"/>

                                                        <f:ajax listener="#{productoFrm.productoTipoProductoFrm.seleccionarCaracteristicaAsignada}"
                                                                execute="lstAsignadas"
                                                                render=":tabProducto:pnlTipoProducto :tabProducto:pnlDetalleProducto :tabProducto:frmDetalleProducto:panelEquivalencia"/>

                                                    </h:selectOneListbox>

                                                    <h:panelGrid id="panelEquivalencia" columns="2" rendered="#{not empty productoFrm.productoTipoProductoFrm.seleccionCaracteristicaAsignada}">
                                                        <h:outputLabel value="Equivalencia (según unidad):" for="txtEquivalencia"/>
                                                        <p:inputText id="txtEquivalencia"
                                                                     value="#{productoFrm.productoTipoProductoFrm.equivalenciaEditable}"
                                                                     required="true"/>

                                                        <h:outputLabel value="Unidad:"/>
                                                        <h:outputText styleClass="success" value="#{productoFrm.productoTipoProductoFrm.seleccionCaracteristicaAsignada.idCaracteristica.idTipoUnidadMedida.unidadBase}"/>

                                                        <p:commandButton value="Guardar equivalencia"
                                                                         actionListener="#{productoFrm.productoTipoProductoFrm.guardarEquivalenciaHandler}"
                                                                         update=":tabProducto:pnlTipoProducto :tabProducto:pnlDetalleProducto :tabProducto:frmDetalleProducto:panelEquivalencia :tabProducto:growlDetalleProducto"
                                                                         process="@this txtEquivalencia lstAsignadas"/>
                                                    </h:panelGrid>

                                                </h:panelGrid>


                                            </h:panelGrid>
                                        </h:panelGrid>
                                    </h:panelGroup>

                                    <h:outputLabel for="chkActivo" value="Activo:"/>
                                    <p:selectBooleanCheckbox id="chkActivo"
                                                             value="#{productoFrm.productoTipoProductoFrm.registro.activo}"/>

                                    <p:outputLabel for="dpFechaCreacion" value="Fecha de creación"/>
                                    <p:datePicker id="dpFechaCreacion"
                                                  value="#{productoFrm.productoTipoProductoFrm.registro.fechaCreacion}"
                                                  showTime="true"
                                                  hourFormat="24"
                                                  timeInput="true"
                                                  timeZone="America/El_Salvador"
                                                  pattern="yyyy-MM-dd HH:mm:ss"
                                                  required="true"
                                                  requiredMessage="La fecha es obligatoria"
                                                  touchUI="false"/>

                                    <h:outputLabel for="txtComentarios" value="Comentarios:"/>
                                    <p:inputTextarea id="txtComentarios"
                                                     value="#{productoFrm.productoTipoProductoFrm.registro.observaciones}"
                                                     rows="4" cols="50"/>
                                </h:panelGrid>
                                <ues:botones-crud formulario="#{productoFrm.productoTipoProductoFrm}"
                                                  actualizar=":tabProducto:pnlTipoProducto :tabProducto:pnlDetalleProducto"/>
                            </h:form>
                        </h:panelGrid>
                    </h:panelGroup>
                </h:panelGrid>
            </p:tab>
        </p:tabView>

    </ui:define>
    <ui:define name="extra">
        <p:dialog id="dlgTipoProducto" widgetVar="dlgTipoProducto" modal="true" closable="true">
            <h:form id="frmDlgTipoProducto">
                <h:panelGrid>
                    <h:panelGrid columns="2">
                        <p:outputLabel value="Seleccione el Tipo de Producto:" for="txtTipoProducto"/>
                        <p:autoComplete id="txtTipoProducto"
                                        completeMethod="#{productoFrm.productoTipoProductoFrm.buscarTiposPorNombres}"
                                        value="#{productoFrm.productoTipoProductoFrm.registro.idTipoProducto}"
                                        var="tp"
                                        converter="tipoProductoConverter"
                                        itemLabel="#{tp.nombre}"
                                        itemValue="#{tp}"
                                        forceSelection="true"
                                        dropdown="true"
                                        size="40"
                                        placeholder="Escribe el nombre del tipo de producto"
                                        emptyMessage="No se encontraron tipos de producto activos con ese nombre"/>
                    </h:panelGrid>
                    <h:commandButton value="Seleccionar" procces="@from"
                                     actionListener="#{productoFrm.productoTipoProductoFrm.btnSeleccionarTipoProductoHandler}"
                                     update=":tabProducto:frmDetalleTipoProducto:pnlTipoProducto"
                                     oncomplete="PF('dlgTipoProducto').hide();"/>
                </h:panelGrid>
            </h:form>
        </p:dialog>
    </ui:define>
</ui:composition>
